name: Build and Deploy to GKE using Helm

on:
  workflow_dispatch:
    inputs:
      tags:
        description: 'Helm manual run'
        required: false

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GAR_LOCATION: europe
  GKE_CLUSTER: mcs-use1-npr-gke-auto
  GKE_ZONE: us-east1
  DEPLOYMENT_NAME: endocode-app
  REPOSITORY: go-docker
  IMAGE: endocode
  TAG: latest

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Analyse, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production

    strategy:
      fail-fast: true
      matrix:
        language: [ 'go' ]

    permissions:
      actions: read
      contents: read
      id-token: write
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - id: 'auth'
        uses: 'google-github-actions/auth@v0'
        with:
          credentials_json: '${{ secrets.GCP_ENDOCODE }}'
          token_format: 'access_token'

      - name: Docker configuration
        run: |-
          echo ${{steps.auth.outputs.access_token}} | docker login -u oauth2accesstoken --password-stdin https://$GAR_LOCATION-docker.pkg.dev
      # Get the GKE credentials so we can deploy to the cluster
      - name: Set up GKE credentials
        uses: google-github-actions/get-gke-credentials@v0
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      # Build the Docker image
      - name: Build
        run: |-
          docker build \
            --tag "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:$TAG" \
            --build-arg GITHUB_SHA="$GITHUB_SHA" \
            --build-arg GITHUB_REF="$GITHUB_REF" \
            .

      # Push the Docker image to Google Artifact Registry
      - name: Publish
        run: |-
          docker push "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:$TAG"

      # Helm works on files, so downloading it
      - name: Download repository
        uses: actions/download-artifact@v2
        with:
          name: endocode
      #creating kube config from the GitHub secret. Got the config by "kubectl config view --flatten > ~/Desktop/k.txt"
      - name: Create kube config
        run: |
          mkdir -p $HOME/.kube/
          echo "${{ secrets.KUBE_CONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      # Deploy with Helm
      - name: Install Helm
        uses: azure/setup-helm@v1
        with:
          version: v3.8.2
      # Last check
      - name: Lint helm charts
        run: helm lint ./chart/
      # deploy
      - name: Deploy
        run: |
          helm upgrade --install --atomic --timeout 1m rest ./chart/ -f ./chart/values.yaml \
            --kube-context mcs-use1-npr-gke-auto --namespace dev --create-namespace \
            --set image.tag=${{ needs.setup.outputs.tag }}
          
          kubectl -n dev get services -o wide